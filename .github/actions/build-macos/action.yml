name: 'Build macOS DMG'
description: 'æž„å»º macOS åº”ç”¨å¹¶ç”Ÿæˆ DMG æ–‡ä»¶'
inputs:
  app-version:
    description: 'åº”ç”¨ç‰ˆæœ¬å·'
    required: true
  macos-certificate-base64:
    description: 'macOS Distribution Certificate (Base64)'
    required: false
    default: ''
  macos-certificate-password:
    description: 'macOS Certificate Password'
    required: false
    default: ''
  apple-team-id:
    description: 'Apple Team ID'
    required: false
    default: ''
  apple-id:
    description: 'Apple ID (email address) for notarization'
    required: false
    default: ''
  apple-app-password:
    description: 'Apple App-specific Password for notarization'
    required: false
    default: ''
outputs:
  dmg-path:
    description: 'ç”Ÿæˆçš„ DMG æ–‡ä»¶è·¯å¾„'
    value: ${{ steps.package.outputs.dmg_path }}
runs:
  using: 'composite'
  steps:
    - name: Build Web and copy assets
      shell: bash
      run: |
        chmod +x build_and_copy_web.sh
        ./build_and_copy_web.sh
    
    - name: Prepare macOS build environment
      shell: bash
      run: |
        cd macos
        export LANG=zh_CN.UTF-8
        export LC_ALL=zh_CN.UTF-8
        mkdir -p ~/.cocoapods
        echo 'source "https://cdn.cocoapods.org/"' > ~/.cocoapods/config
        echo "Cleaning existing Pods and cache for a fresh mdk nightly..."
        rm -rf Pods Podfile.lock
        pod cache clean fvp || true # Clean fvp pod's cache, which handles mdk
        pod cache clean --all
        echo "Running pod install --repo-update (this will run fvp/apple_deps.sh to get mdk nightly)..."
        pod install --repo-update
        cd ..

    - name: Setup Code Signing
      shell: bash
      run: |
        # æ£€æŸ¥æ˜¯å¦æä¾›äº†ç­¾åè¯ä¹¦
        if [ -n "${{ inputs.macos-certificate-base64 }}" ] && [ -n "${{ inputs.apple-team-id }}" ]; then
          echo "ðŸ” è®¾ç½®macOSä»£ç ç­¾å..."
          
          # å¯¼å…¥è¯ä¹¦åˆ°keychain
          echo "${{ inputs.macos-certificate-base64 }}" | base64 --decode > certificate.p12
          
          # åˆ›å»ºä¸´æ—¶keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD="temp_keychain_password"
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # å¯¼å…¥è¯ä¹¦
          security import certificate.p12 -P "${{ inputs.macos-certificate-password }}" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # è®¾ç½®è¯ä¹¦æƒé™
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # æ¸…ç†è¯ä¹¦æ–‡ä»¶
          rm certificate.p12
          
          echo "âœ… è¯ä¹¦å¯¼å…¥æˆåŠŸ"
          echo "ENABLE_CODE_SIGNING=true" >> $GITHUB_ENV
          echo "APPLE_TEAM_ID=${{ inputs.apple-team-id }}" >> $GITHUB_ENV
          
          # è®¾ç½®å…¬è¯ç›¸å…³çŽ¯å¢ƒå˜é‡
          if [ -n "${{ inputs.apple-id }}" ] && [ -n "${{ inputs.apple-app-password }}" ]; then
            echo "ENABLE_NOTARIZATION=true" >> $GITHUB_ENV
            echo "APPLE_ID=${{ inputs.apple-id }}" >> $GITHUB_ENV
            echo "APPLE_APP_PASSWORD=${{ inputs.apple-app-password }}" >> $GITHUB_ENV
            echo "âœ… å…¬è¯ä¿¡æ¯å·²é…ç½®"
          else
            echo "ENABLE_NOTARIZATION=false" >> $GITHUB_ENV
            echo "âš ï¸ æœªæä¾›å…¬è¯ä¿¡æ¯ï¼Œåº”ç”¨å°†ä»…ç­¾åä¸å…¬è¯"
          fi
        else
          echo "âš ï¸ æœªæä¾›ç­¾åè¯ä¹¦ï¼Œå°†æž„å»ºæœªç­¾åç‰ˆæœ¬"
          echo "ENABLE_CODE_SIGNING=false" >> $GITHUB_ENV
        fi

    - name: Build macOS App
      shell: bash
      run: |
        if [ "$ENABLE_CODE_SIGNING" = "true" ]; then
          echo "ðŸ”¨ æž„å»ºå·²ç­¾åçš„macOSåº”ç”¨..."
          flutter build macos --release \
            --dart-define=APPLE_TEAM_ID=$APPLE_TEAM_ID
        else
          echo "ðŸ”¨ æž„å»ºæœªç­¾åçš„macOSåº”ç”¨..."
          flutter build macos --release
        fi

    - name: Sign macOS App
      shell: bash
      run: |
        if [ "$ENABLE_CODE_SIGNING" = "true" ]; then
          echo "ðŸ” å¯¹macOSåº”ç”¨è¿›è¡Œä»£ç ç­¾å..."
          
          APP_PATH="build/macos/Build/Products/Release/NipaPlay.app"
          
          # æŸ¥æ‰¾å¯ç”¨çš„ç­¾åèº«ä»½
          echo "å¯ç”¨çš„ç­¾åèº«ä»½ï¼š"
          security find-identity -v -p codesigning
          
          # èŽ·å–è¯ä¹¦ä¿¡æ¯
          echo "æŸ¥æ‰¾å¯ç”¨çš„ä»£ç ç­¾åè¯ä¹¦..."
          CERT_LIST=$(security find-identity -v -p codesigning)
          echo "è¯ä¹¦åˆ—è¡¨ï¼š"
          echo "$CERT_LIST"
          
          # é¦–å…ˆå°è¯• Developer ID Application è¯ä¹¦ï¼ˆç”¨äºŽåˆ†å‘ï¼‰
          CERT_NAME=$(echo "$CERT_LIST" | grep "Developer ID Application" | head -1 | sed 's/.*) \([0-9A-F]*\) "\(.*\)"/\2/')
          
          if [ -z "$CERT_NAME" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°Developer ID Applicationè¯ä¹¦ï¼ŒæŸ¥æ‰¾Apple Developmentè¯ä¹¦..."
            # å¤‡é€‰ï¼šæŸ¥æ‰¾ Apple Development è¯ä¹¦
            CERT_NAME=$(echo "$CERT_LIST" | grep "Apple Development" | head -1 | sed 's/.*) \([0-9A-F]*\) "\(.*\)"/\2/')
          fi
          
          if [ -z "$CERT_NAME" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°Apple Developmentè¯ä¹¦ï¼ŒæŸ¥æ‰¾å…¶ä»–å¯ç”¨è¯ä¹¦..."
            # æœ€åŽå¤‡é€‰ï¼šæŸ¥æ‰¾ä»»ä½•å¯ç”¨è¯ä¹¦
            CERT_NAME=$(echo "$CERT_LIST" | grep -E "(Developer|Apple)" | head -1 | sed 's/.*) \([0-9A-F]*\) "\(.*\)"/\2/')
          fi
          
          if [ -n "$CERT_NAME" ]; then
            echo "ä½¿ç”¨è¯ä¹¦: $CERT_NAME"
            
            # å¯¹App Bundleè¿›è¡Œæ·±åº¦ç­¾å
            echo "æ­£åœ¨å¯¹æ¡†æž¶è¿›è¡Œç­¾å..."
            for framework in "$APP_PATH/Contents/Frameworks/"*.framework; do
              if [ -d "$framework" ]; then
                echo "ç­¾åæ¡†æž¶: $framework"
                codesign --force --verbose --sign "$CERT_NAME" \
                  --options runtime \
                  --entitlements macos/Runner/Release.entitlements \
                  "$framework"
              fi
            done
              
            echo "æ­£åœ¨å¯¹ä¸»åº”ç”¨è¿›è¡Œç­¾å..."
            echo "åº”ç”¨è·¯å¾„: $APP_PATH"
            echo "è¯ä¹¦åç§°: $CERT_NAME"
            echo "æƒé™æ–‡ä»¶: macos/Runner/Release.entitlements"
            
            # æ£€æŸ¥æƒé™æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "macos/Runner/Release.entitlements" ]; then
              echo "âŒ æƒé™æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            
            # æ£€æŸ¥åº”ç”¨è·¯å¾„æ˜¯å¦å­˜åœ¨
            if [ ! -d "$APP_PATH" ]; then
              echo "âŒ åº”ç”¨è·¯å¾„ä¸å­˜åœ¨: $APP_PATH"
              exit 1
            fi
            
            codesign --force --verbose --sign "$CERT_NAME" \
              --options runtime \
              --entitlements macos/Runner/Release.entitlements \
              "$APP_PATH"
              
            # éªŒè¯ç­¾å
            codesign --verify --verbose "$APP_PATH"
            echo "âœ… åº”ç”¨ç­¾åå®Œæˆ"
          else
            echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç­¾åè¯ä¹¦"
            exit 1
          fi
        else
          echo "â­ï¸ è·³è¿‡åº”ç”¨ç­¾åï¼ˆæœªæä¾›è¯ä¹¦ï¼‰"
        fi

    - name: Notarize macOS App
      shell: bash
      run: |
        if [ "$ENABLE_NOTARIZATION" = "true" ] && [ "$ENABLE_CODE_SIGNING" = "true" ]; then
          echo "ðŸ” å¼€å§‹å…¬è¯ macOS åº”ç”¨..."
          
          APP_PATH="build/macos/Build/Products/Release/NipaPlay.app"
          
          # éªŒè¯åº”ç”¨å·²æ­£ç¡®ç­¾å
          if ! codesign --verify --verbose "$APP_PATH" 2>/dev/null; then
            echo "âŒ åº”ç”¨ç­¾åéªŒè¯å¤±è´¥ï¼Œæ— æ³•è¿›è¡Œå…¬è¯"
            exit 1
          fi
          
          # åˆ›å»º zip æ–‡ä»¶ç”¨äºŽå…¬è¯
          echo "ðŸ“¦ åˆ›å»ºåº”ç”¨åŽ‹ç¼©åŒ…..."
          ditto -c -k --keepParent "$APP_PATH" "NipaPlay.zip"
          
          # ä¸Šä¼ å…¬è¯
          echo "â˜ï¸ ä¸Šä¼ åˆ° Apple è¿›è¡Œå…¬è¯..."
          if ! xcrun notarytool submit "NipaPlay.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait; then
            echo "âŒ å…¬è¯å¤±è´¥"
            rm "NipaPlay.zip"
            exit 1
          fi
          
          echo "âœ… å…¬è¯å®Œæˆ"
          
          # é™„åŠ å…¬è¯ç¥¨æ®åˆ°åº”ç”¨
          echo "ðŸŽ« é™„åŠ å…¬è¯ç¥¨æ®..."
          
          # ç­‰å¾…ä¸€ä¸‹ï¼Œè®© Apple æœåŠ¡å™¨å‡†å¤‡å¥½ç¥¨æ®
          echo "ç­‰å¾…å…¬è¯ç¥¨æ®å‡†å¤‡å°±ç»ª..."
          sleep 30
          
          # å°è¯•é™„åŠ ç¥¨æ®ï¼Œæœ€å¤šé‡è¯•3æ¬¡
          STAPLE_SUCCESS=false
          for attempt in 1 2 3; do
            echo "å°è¯•é™„åŠ ç¥¨æ® (ç¬¬ $attempt æ¬¡)..."
            if xcrun stapler staple "$APP_PATH"; then
              echo "âœ… å…¬è¯ç¥¨æ®é™„åŠ æˆåŠŸ"
              STAPLE_SUCCESS=true
              break
            else
              echo "âš ï¸ ç¬¬ $attempt æ¬¡é™„åŠ å¤±è´¥"
              if [ $attempt -lt 3 ]; then
                echo "ç­‰å¾… 60 ç§’åŽé‡è¯•..."
                sleep 60
              fi
            fi
          done
          
          if [ "$STAPLE_SUCCESS" = "false" ]; then
            echo "âŒ å…¬è¯ç¥¨æ®é™„åŠ å¤±è´¥"
            rm -f "NipaPlay.zip"
            exit 1
          fi
          
          # éªŒè¯å…¬è¯
          if xcrun stapler validate "$APP_PATH"; then
            echo "âœ… å…¬è¯éªŒè¯æˆåŠŸ - åº”ç”¨çŽ°åœ¨å¯ä»¥ç›´æŽ¥è¿è¡Œ"
          else
            echo "âŒ å…¬è¯éªŒè¯å¤±è´¥"
            rm -f "NipaPlay.zip"
            exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "NipaPlay.zip"
          
        elif [ "$ENABLE_CODE_SIGNING" = "true" ]; then
          echo "âš ï¸ åº”ç”¨å·²ç­¾åä½†æœªå…¬è¯ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦æ‰‹åŠ¨å…è®¸è¿è¡Œ"
        else
          echo "â­ï¸ è·³è¿‡å…¬è¯ï¼ˆæœªç­¾åæˆ–æœªé…ç½®ï¼‰"
        fi

    - name: Copy mdk.framework.dSYM to App Bundle
      shell: bash
      run: |
        echo "Attempting to copy mdk.framework.dSYM for symbolication..."
        MDK_ARTIFACTS_DIR="macos/Pods/mdk"
        DSYM_SOURCE_PATH="${MDK_ARTIFACTS_DIR}/mdk.framework.dSYM"
        
        APP_BUNDLE_NAME="NipaPlay.app"
        APP_BUNDLE_ROOT_DIR="build/macos/Build/Products/Release"
        TARGET_DSYM_DIR="${APP_BUNDLE_ROOT_DIR}/${APP_BUNDLE_NAME}/Contents/Frameworks"

        if [ -d "$DSYM_SOURCE_PATH" ]; then
          echo "Found mdk.framework.dSYM at $DSYM_SOURCE_PATH"
          
          if [ ! -d "${APP_BUNDLE_ROOT_DIR}/${APP_BUNDLE_NAME}" ]; then
            echo "Error: App bundle ${APP_BUNDLE_ROOT_DIR}/${APP_BUNDLE_NAME} not found after flutter build."
            echo "Listing contents of ${APP_BUNDLE_ROOT_DIR}/:"
            ls -la "${APP_BUNDLE_ROOT_DIR}/"
            exit 1
          fi
          
          if [ ! -d "$TARGET_DSYM_DIR" ]; then
             echo "Warning: Target Frameworks directory $TARGET_DSYM_DIR does not exist. Will attempt to create it."
             mkdir -p "$TARGET_DSYM_DIR"
          fi

          echo "Copying $DSYM_SOURCE_PATH to $TARGET_DSYM_DIR/"
          cp -R "$DSYM_SOURCE_PATH" "$TARGET_DSYM_DIR/"
          if [ $? -eq 0 ]; then
            echo "Successfully copied mdk.framework.dSYM from $DSYM_SOURCE_PATH."
            echo "Contents of $TARGET_DSYM_DIR after copy:"
            ls -la "$TARGET_DSYM_DIR"
          else
            echo "Error: Failed to copy mdk.framework.dSYM from $DSYM_SOURCE_PATH."
            exit 1
          fi
        else
          echo "Warning: mdk.framework.dSYM not found at the revised expected path $DSYM_SOURCE_PATH."
          echo "Symbolicated crash logs for mdk might not be available."
        fi

    - name: Package macOS DMG
      id: package
      shell: bash
      run: |
        brew install coreutils create-dmg imagemagick
        chmod +x dmg.sh
        
        # Set up environment for GUI operations in CI
        export DISPLAY=:99
        
        # Try to create DMG with timeout and retry mechanism
        gtimeout 300 ./dmg.sh || {
          echo "DMG creation timed out or failed, trying fallback approach with layout..."
          
          # Fallback: Create DMG with layout but without complex AppleScript operations
          version="${{ inputs.app-version }}"
          dmg_name="NipaPlay_${version}_macOS_Universal.dmg"
          
          # Create a temporary directory for the DMG layout
          temp_dir=$(mktemp -d)
          mkdir -p "${temp_dir}/.background"
          
          # Copy the app to the temporary directory
          cp -R "build/macos/Build/Products/Release/NipaPlay.app" "${temp_dir}/"
          
          # Create a symbolic link to Applications
          ln -s /Applications "${temp_dir}/Applications"
          
          # Create the background image with arrow (fallback version)
          magick -size 800x450 xc:white \
            -font Arial-Bold -pointsize 120 -fill '#666666' \
            -gravity center \
            -draw "text -150,0 'NipaPlay'" \
            -draw "text 150,0 '> '" \
            "${temp_dir}/.background/background.png" || {
              # If ImageMagick fails, create simple background
              magick -size 800x450 xc:'#f0f0f0' "${temp_dir}/.background/background.png"
            }
          
          # Create DMG with layout (CI-friendly version)
          create-dmg \
            --volname "NipaPlay-${version}" \
            --window-pos 200 120 \
            --window-size 800 450 \
            --icon-size 100 \
            --icon "NipaPlay.app" 200 185 \
            --icon "Applications" 600 185 \
            --background "${temp_dir}/.background/background.png" \
            --no-internet-enable \
            --skip-jenkins \
            "${dmg_name}" \
            "${temp_dir}" || {
              # Final fallback: simple DMG without background
              echo "Fallback with layout failed, creating simple DMG..."
              rm -f "${dmg_name}"
              create-dmg \
                --volname "NipaPlay-${version}" \
                --window-size 800 450 \
                --icon-size 100 \
                --app-drop-link 600 185 \
            --no-internet-enable \
            --skip-jenkins \
            "${dmg_name}" \
            "build/macos/Build/Products/Release/NipaPlay.app"
            }
          
          # Clean up
          rm -rf "${temp_dir}"
        }
        
        echo "Listing final DMG:"
        ls -la *.dmg
        
        # Set output
        dmg_file=$(ls NipaPlay_*_macOS_Universal.dmg | head -1)
        echo "dmg_path=$dmg_file" >> $GITHUB_OUTPUT

